<section class="establishment" id="establishment">
    <div class="header" style="background-image: url({{estData.path}});">
      <div class="content"></div>
    </div>
    <div class="content-text">
      <div class="text-container">
        <span id="est_rating" class="rating">Rating: {{rating}}/5 ({{postLength}} review/s)</span>
        <a href="" class="custom-button">Review Now</a>
      </div>
    </div>

    <div class="description-content">
      <img src="{{estData.icon}}" class="aligned-image">
      <p class="image-description">
        {{estData.description}}
      </p>
    </div>

    

    {{#each postData}}
      <div class="comment-container">
        <div class="profile-picture">
          <img src="{{this.cust_profpic}}" alt="Profile Picture">
        </div>
        <div class="comment-content">
          <span class="comment-author">
            {{this.cust_name}}
          </span>
          &nbsp &nbsp &nbsp
          <span class="comment-author post-ratings">
            {{this.rating}}/5
          </span>

          <p class="comment-text">
            {{this.review}}
          </p>
          <span class="comment-time">143 hours ago</span>
          <div class="comment-buttons">
            <input type="hidden" id="postid" value="{{this._id}}" >
            <button id="helpful" class="helpful-button">Helpful 
                {{this.helpful_num}}</button>
            <button id="nothelpful" >Not Helpful 
                {{this.nothelpful_num}}</button>

            <form action="/comment" method="POST">
              <textarea placeholder="write a comment..." name="comment"></textarea>
              <div class="row button">
                <!-- <input type="submit" value="comment_btn" id="login-btn"> -->
                <button type="submit" value="comment_btn" id="submitcommentbtn">Add Comment</button>

                <!-- Hidden input field -->
                <input type="hidden" name="post_number" value="{{this._id}}">
              </div>
            </form>

          </div>

        </div>
      </div>
      {{/each}}

      <script>
        //const rating = parseInt(document.querySelector('#est_rating').innerText.substring(8,9));
        const post_ratings = document.querySelectorAll('.post-ratings');
        const helpfulBtn = document.querySelector('#helpful');
        const postid = document.querySelector('#postid');
        const nothelpfulBtn = document.querySelector('#nothelpful');
        const container = document.querySelector('#starrating');
        const submitCommentBtn = document.querySelector('#submitcommentbtn');
        
        submitCommentBtn.addEventListener('click', async function (e) {
          e.preventDefault();
          const commentForm = document.forms.comment_form;
          const formData = new FormData(commentForm);
          // Translate the FormData object to a JS object
          const data = {};
          for (const entry of formData.entries()) {
              console.log(`${entry[0]}, ${entry[1]}`);
              data[entry[0]] = entry[1];
          }
          // Serialize the JS object into JSON string
          const json = JSON.stringify(data);
          console.log(json);
          // Send request to server
          const response = await fetch('/comment', {
              method: 'POST',
              body: json,
              headers: {
                  "Content-Type": "application/json"
              }
          });

          // resets the form's fields
          commentForm.reset();

          // Process response
          {{!-- if (response.status == 200) {
              // Update list without refreshing page
              const card = 
                  `<div class="card">
                      <img src="/images/icon.webp" class="icon">
                      <div class="info">
                          <p class="text"> ${formData.get('name')} </p>
                          <p class="text"> ${formData.get('refno')} </p>
                          <p class="text"> Php ${formData.get('amount')} </p>
                      </div>
                      <button class="remove"> X </button>
                  </div>`;
              
              cardsDiv.innerHTML += card;
          } else {
              console.log(`received response: ${response.status}`);
          } --}}
        });

        helpfulBtn.addEventListener('click', async function (e) {
          e.preventDefault();
          const postId = postid.value;  
          const response = await fetch('/updateHelpful?postId=' + postId,{
              method: 'GET',
          });
          if (response.status == 400) {
              helpfulBtn.innerText = "Helpful " + (parseInt(helpfulBtn.innerText.substring(8)) + 1).toString();
          } else if (response.status == 200){
              console.log('ok');
          }
        });

        nothelpfulBtn.addEventListener('click', async function (e) {
          e.preventDefault();
          const postId = postid.value;  
          const response = await fetch('/updateNotHelpful?postId=' + postId,{
              method: 'GET',
          });
          if (response.status == 400) {
              nothelpfulBtn.innerText = "Not Helpful " + (parseInt(nothelpfulBtn.innerText.substring(12)) + 1).toString();
          } else if (response.status == 200){
              console.log('ok');
          }
        });

        window.addEventListener('load',  (event) => {
          console.log(post_ratings);
            for(let i = 0; i != post_ratings.length; i++) {
              let rating = post_ratings[i].innerText.substring(0,1);
              console.log(rating);
              let text_rating = document.createElement("p");
              text_rating.innerText = post_ratings[i].innerText;
              //post_ratings[i].innerText="";
              for (let j = 0; j != rating; j++) {
                let star = document.createElement("i");
                star.classList.add("fas");
                star.classList.add("fa-star");
                star.classList.add("star-icon");
                post_ratings[i].prepend(star);
              }
              //post_ratings[i].appendChild(text_rating);
            }
        });

        
      </script>
    

  </section>